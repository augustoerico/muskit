# Audit

Collection of functions used to audit the `ExperimentalData` results

## Files analyzed

### Specification
`<QP>_test_oracle.txt`: Quantum program's `QP` Probabilities Oracle in the form:
```
(<input>, <output>): <probability>
...
```
Where:
- `input`: quantum circuit decimal input. Example: `27`
- `output`: quantum circuit decimal output. Example: `2`
- `probability`: probability of observing the `output`, given `input`. Example: `0.24999999999999994`

### Raw results
`results.txt`: output results from mutants executions in the form:
```
The result of <mutant-file-path> with input [<input>] is: {'<output-1>': <count-1>, '<output-2>': <count-2>, ...}
...
```
Where:
- `mutant-file-path`: is the path of file. Example: `C:/Users/complex/Desktop/QuantumMutationTesting/QRam/AllMutants/1AddGate_x_inGap_1_.py`
- `input`: binary input for the quantum circuit. Example: `000000`
- `output-N`: binary output from the quantum circuit. Example: `000100`
- `count-N`: number of occurences of given `output-N`

### Accumulated results
`cleanResults.txt`: output from `resultsAnalyzer` that accumulates the (input, output) obtained from `results.txt` based on the measured qubits defined in the `resultsAnalyzer/analyzerConfig.py` (same as `resultsAnalyzer/configs/default.analyzer.toml`). It has the form:
```
<mutant-file>------------------------------------------------------------------
(<input>, <output>): <probability>
...
```
Where:
- `mutant-file`: mutant file name (`stem`). Example: `1AddGate_x_inGap_1_`
- `input`: quantum circuit decimal input. Example: `31`
- `output`: quantum circuit decimal output. Example: `3`
- `probability`: probability of observing the `output`, given `input`. Example: `0.76`

### Final results
`testResults.txt`: the program's final result after analyzing the result against the Wrong Output Oracle (unexpected output observed) and Output Probabilities Oracle (the probability of observing an output compared with the QP specification)

The result for each line can be:

#### Wrong Output observed
An output that does not belong in the specification (unexpected output) was observed.
```
File: <mutant-file> with input [<input>]FAILED DIRECTLY without checking P-Value
```

#### Output Probability rejected
The output probability observed does not match the specification probability after Chi-Squared analyses
```
FILE: <mutant-file> with input [<input>] FAILED WITH P-Value <p-value>
```

#### Output Probability not rejected
The output probability observed could not be rejected from specification probability after Chi-Squared analyses
```
FILE: <mutant-file> with input [<input>] VALID WITH P-Value <p-value>
```

Where:
- `mutant-file`: mutant file name (`stem`). Example: `1AddGate_x_inGap_1_`
- `input`: quantum circuit decimal input. Example: `31`
- `p-value`: Chi-Squared resulting p-value

## Auditing process

The files generated by each step in the auditing process are stored in the `audit` folder, inside the corresponding Quantum Program folder in `ExperimentalData`.
The auditing steps are:

- Parse `results.txt` into multiple JSON files, one for each mutant program, to make it easier to manipulate as `dictionary`. The files are stored in the `results_json`.
- Parse `<QP>_test_oracle.txt` into a JSON file `oracle.json` with the equivalent transformations:
-- `<input>` decimal becomes binary. The length is defined by the highest INPUT number observed in the specification. Example: if the highest number is `31`, the `input` has 5 qubits length
-- `<output>` decimal becomes binary. The length is defined by the hightes OUTPUT number observed in the specification. Example: if the highest number is `3`, the `output` has 2 qubits length
- Accumulate `results_json/<mutant>.json` as `clean_results/<mutant>.json` according to the measured qubits defined in the configuration `default.analyzer.toml` (same as `analyzerConfig.py`). It uses COUNTS instead of PROBABILITIES, in the form:
```json
{
    "<input-1>": {
        "<output-1.1>": <count-1.1>,
        "<output-1.2>": <count-1.2>,
        ...
    },
    "<input-2>": {
        "<output-2.1>": <count-2.1>,
        "<output-2.2>": <count-2.2>,
        ...
    }
    ...
}
```
-- Where `<input-N>` the QP input N, `<output-N.M>: <count-N.M>` is the number of occurrences of output M, for the given input N
- Get expected counts `oracle_counts.json` from `oracle.json`, considering the number of times the mutant was simulated (number of "shots"), extracted from `Muskit/configs/default.executor.toml` (same as `Muskit/executorConfig`)
- Compare the observed outputs with expected and store in `compared/<mutant>.json`:
-- if there is a Wrong Output, it DOES NOT calculate the p-value; instead, it gives the observed and expected output with the related counts
```json
{
    "<input>": {
        "observed_outputs": {
            "<output-1.1>": <count-1.1>,
            "<output-1.2>": <count-1.2>,
            ...
        },
        "expected_outputs": {
            "<output-2.1>": <count-2.1>,
            "<output-2.2>": <count-2.2>,
            ...
        },
        "wrong_output": true
    },
    ...
}
```
-- otherwise, it calculates the p-value from observed outputs againts expectedusing `scipy.chisquare`. It also includes the arguments used in the `scipy.chisquare` call
```json
{
    "<input>": {
        "observed_outputs": {
            "<output-1.1>": <count-1.1>,
            "<output-1.2>": <count-1.2>,
            ...
        },
        "expected_outputs": {
            "<output-2.1>": <count-2.1>,
            "<output-2.2>": <count-2.2>,
            ...
        },
        "wrong_output": false,
        "f_obs": [ <count-1.1>, <count-1.2> ],
        "f_exp": [ <count-2.1>, <count-2.2> ],
        "pvalue": <p-value>
    },
    ...
}
```
- Compare audit results with `testResults.txt`. For each line in `testResult.txt`, it evaluates if the conclusion is correct or not and stores into `audit_results.json` (which contains all evaluations) and `audit_results_wrong.json`, that contains only the results that diverge from the original
